<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airline Passenger Satisfaction — Wide &amp; Deep (TF.js)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js" defer></script>
  <style>
    :root{ --bg:#0b0f17; --panel:#0f1524; --ink:#e9edf6; --muted:#a7b0c3; --border:rgba(255,255,255,.12); --glass:rgba(255,255,255,.06); }
    *{box-sizing:border-box}
    body{margin:0;padding:26px;background:linear-gradient(180deg,#0a0f1a,#0b0f17);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1200px;margin:0 auto}
    h1{margin:0 0 10px 0}
    h2{margin:0 0 12px 0}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:8px;background:var(--glass);color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="file"],button,select{background:var(--glass);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    button:hover:not([disabled]){outline:1px solid #8aa3ff}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:8px 12px}
    table{border-collapse:collapse;width:100%;background:var(--glass);border:1px solid var(--border)}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:.95rem;white-space:nowrap}
    th{position:sticky;top:0;background:rgba(255,255,255,.05)}
    .scroll{max-height:320px;overflow:auto}
    pre{white-space:pre-wrap;background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:12px}
    canvas{width:100%;height:280px;border:1px solid var(--border);border-radius:12px;background:#0f1628}
    .cm{display:grid;grid-template-columns:140px 90px 90px;gap:6px;align-items:center}
    .cm div{background:var(--glass);border:1px solid var(--border);padding:8px;border-radius:10px;text-align:center}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;background:#6bd66b}
    .dot.busy{background:#f5a524;animation:pulse 1s infinite}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;min-width:260px;max-width:90vw;background:#2b2f3b;color:#fff;border:1px solid #444;border-radius:10px;padding:10px 14px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:999}
    .toast.hidden{display:none}
    @keyframes pulse{50%{transform:translateX(-50%) scale(1.15)}}
  </style>
  <script>
    // Create a global namespace early so inline handlers never throw
    window.__app = {};
  </script>
  <script src="app.js?v=20251022" defer></script>
</head>
<body>
<div class="wrap">
  <h1>Airline Passenger Satisfaction — Wide & Deep (TF.js)</h1>
  <div class="badge">GPU/WebGL backend • smaller deep model • fewer epochs • bigger batch. Upload CSVs → Preprocess → Build → Train → ROC → Predict/Export.</div>

  <div class="panel">
    <h2>Data Load</h2>
    <div class="row">
      <label>train.csv
        <input id="trainFile" type="file" accept=".csv,text/csv">
      </label>
      <label>test.csv
        <input id="testFile" type="file" accept=".csv,text/csv">
      </label>
      <button id="btnLoad" type="button" onclick="__app.load()">Load Files</button>
      <div class="kpis">
        <div class="kpi">Train rows: <b id="kTrain">—</b></div>
        <div class="kpi">Test rows: <b id="kTest">—</b></div>
        <div class="kpi">Missing%: <b id="kMiss">—</b></div>
        <div class="kpi">Repairs: <b id="fixNote">—</b></div>
      </div>
    </div>
    <div class="scroll" id="previewTable"></div>
  </div>

  <div class="panel">
    <h2>Preprocessing</h2>
    <div class="row">
      <label>Use case
        <select id="useCase">
          <option value="post">Post-flight recovery (allow ArrivalDelay)</option>
          <option value="pre">Pre-flight prediction (exclude ArrivalDelay)</option>
        </select>
      </label>
      <label><input id="featCross" type="checkbox" checked> Cross: Class×TypeOfTravel</label>
      <label><input id="featDelay" type="checkbox" checked> Feature: TotalDelay</label>
      <button id="btnPre" type="button" onclick="__app.preprocess()">Run Preprocessing</button>
    </div>
    <pre id="preInfo">—</pre>
  </div>

  <div class="panel">
    <h2>Model (Wide & Deep)</h2>
    <div class="row">
      <button id="btnBuild" type="button" onclick="__app.buildModel()">Build Model</button>
      <button id="btnSummary" type="button" onclick="__app.showSummary()">Show Summary</button>
    </div>
    <pre id="modelSummary">—</pre>
  </div>

  <div class="panel">
    <h2>Training</h2>
    <div class="row" style="gap:16px;align-items:center">
      <button id="btnTrain" type="button" onclick="__app.train()">Train (25 epochs)</button>
      <button id="btnStop"  type="button" onclick="__app.stop()" disabled>Early Stop</button>
      <span class="badge" id="trainStatus"><span id="trainDot" class="dot"></span><span id="trainText">Idle</span></span>
    </div>
    <pre id="trainLog">—</pre>
  </div>

  <div class="panel">
    <h2>Metrics</h2>
    <div class="row" style="gap:16px;align-items:center">
      <div>Threshold: <b id="thVal">0.50</b></div>
      <input id="thSlider" type="range" min="0" max="1" step="0.01" value="0.5" oninput="__app.updateThreshold(this.value)" style="width:280px">
      <div>AUC: <b id="aucText">—</b></div>
    </div>
    <canvas id="rocCanvas" width="900" height="300"></canvas>
    <div class="row" style="margin-top:10px">
      <div class="cm">
        <div></div><div><b>Pred 1</b></div><div><b>Pred 0</b></div>
        <div><b>True 1</b></div><div id="cmTP">0</div><div id="cmFN">0</div>
        <div><b>True 0</b></div><div id="cmFP">0</div><div id="cmTN">0</div>
      </div>
      <pre id="prf" style="flex:1;margin-left:12px">—</pre>
    </div>
  </div>

  <div class="panel">
    <h2>Predict &amp; Export</h2>
    <div class="row">
      <button id="btnPredict" type="button" onclick="__app.predict()">Predict test.csv</button>
      <button id="btnSub" type="button" onclick="__app.downloadSubmission()">Download submission.csv</button>
      <button id="btnProb" type="button" onclick="__app.downloadProbs()">Download probabilities.csv</button>
      <button id="btnSaveModel" type="button" onclick="__app.saveModel()">Save model</button>
    </div>
    <pre id="predInfo">—</pre>
  </div>
</div>

<div id="toast" class="toast hidden"></div>
</body>
</html>
