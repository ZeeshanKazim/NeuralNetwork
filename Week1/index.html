<!doctype html>
{name:'Not', type:'bar', stack:'x', data:[-fDie, -mDie], label:{show:true, formatter:(d)=>Math.abs(d.value)+'%'}},
]
});
}


function classStack(rows){
const classes=[1,2,3]; const surv=classes.map(c=>rows.filter(r=>r.Pclass===c && Number(r.Survived)===1).length); const die=classes.map(c=>rows.filter(r=>r.Pclass===c && Number(r.Survived)===0).length);
const chart=echarts.init(document.getElementById('chClass'));
chart.setOption({ tooltip:{trigger:'axis',axisPointer:{type:'shadow'}}, legend:{}, grid:{left:60,right:20,top:30,bottom:40}, xAxis:{type:'category', data:['1st','2nd','3rd']}, yAxis:{type:'value'}, series:[{name:'Survived',type:'bar',stack:'tot',data:surv},{name:'Not',type:'bar',stack:'tot',data:die}] });
}


function ageBox(rows){
const g0=rows.filter(r=>Number(r.Survived)===0 && r.Age!=null).map(r=>+r.Age); const g1=rows.filter(r=>Number(r.Survived)===1 && r.Age!=null).map(r=>+r.Age);
function boxStats(a){ const s=a.slice().sort((x,y)=>x-y); const q=(p)=>{const pos=(s.length-1)*p; const b=Math.floor(pos), r=pos-b; return s[b]+(s[b+1]-s[b])*(isNaN(r)?0:r||0)}; return [q(0), q(0.25), q(0.5), q(0.75), q(1)]; }
const data=[boxStats(g0), boxStats(g1)];
const chart=echarts.init(document.getElementById('chAgeBox'));
chart.setOption({ tooltip:{trigger:'item'}, xAxis:{type:'category', data:['Not Survived','Survived']}, yAxis:{type:'value'}, series:[{ type:'boxplot', data }] });
}


function scatter(rows){
const pts=rows.filter(r=>r.Age!=null && r.Fare!=null).map(r=>({ value:[+r.Age, +r.Fare, r.Survived, r.Sex, r.Pclass] }));
const chart=echarts.init(document.getElementById('chScatter'));
chart.setOption({
tooltip:{formatter:(p)=>{const [age,fare,y,sex,pc]=p.data.value; return `Age: ${age}<br/>Fare: ${fare.toFixed(2)}<br/>Survived: ${y==1?'Yes':'No'}<br/>Sex: ${sex}<br/>Pclass: ${pc}`;}},
xAxis:{name:'Age'}, yAxis:{name:'Fare'}, grid:{left:60,right:20,top:20,bottom:50},
series:[{type:'scatter', data:pts, symbolSize:(val)=>Math.max(4, Math.min(14, Math.sqrt(val[1])))}]
});
}


function embarked100(rows){
const ports=['C','Q','S']; const names={C:'Cherbourg',Q:'Queenstown',S:'Southampton'}; const total=ports.map(p=>rows.filter(r=> (r.Embarked||'')===p).length);
const surv=ports.map(p=>rows.filter(r=> (r.Embarked||'')===p && Number(r.Survived)===1).length);
const die=ports.map((_,i)=> total[i]-surv[i]); const perc=(a,b)=> a.map((v,i)=> total[i]? Math.round(v/total[i]*1000)/10 : 0);
const chart=echarts.init(document.getElementById('chEmb'));
chart.setOption({ tooltip:{trigger:'axis', axisPointer:{type:'shadow'}}, legend:{}, grid:{left:80,right:20,top:30,bottom:40}, xAxis:{type:'category', data:ports.map(p=>names[p])}, yAxis:{type:'value', max:100, axisLabel:{formatter:(v)=>v+'%'}}, series:[{name:'Survived %',type:'bar', stack:'x', data:perc(surv,total)},{name:'Not %',type:'bar', stack:'x', data:perc(die,total)}] });
}


function corrHeat(rows){
const cols=['Survived','Pclass','Age','SibSp','Parch','Fare'];
const mat=cols.map(c=> rows.map(r=> r[c]!=null? +r[c] : null));
const z=cols.map((_,i)=> cols.map((_,j)=> +pearson(mat[i],mat[j]).toFixed(2)) );
const data=[]; for(let i=0;i<cols.length;i++){ for(let j=0;j<cols.length;j++){ data.push([i,j,z[i][j]]); } }
const chart=echarts.init(document.getElementById('chCorr'));
chart.setOption({ tooltip:{}, grid:{left:80,right:20,top:20,bottom:40}, xAxis:{type:'category', data:cols}, yAxis:{type:'category', data:cols}, visualMap:{min:-1,max:1, calculable:true, orient:'horizontal', left:'center', bottom:0}, series:[{type:'heatmap', data, label:{show:true, formatter:(p)=>p.data[2].toFixed(2)}}] });
}


function buildAlerts(rows){
const alerts=[]; const miss=missingness(rows);
for(const m of miss){ if(m.percent>=0.4) alerts.push(`⚠️ High missingness in <b>${m.column}</b>: ${(m.percent*100).toFixed(1)}%`); else if(m.percent>=0.2) alerts.push(`ℹ️ Noticeable missingness in <b>${m.column}</b>: ${(m.percent*100).toFixed(1)}%`); }
const withY=rows.filter(r=>r.Survived!=null); if(withY.length){ const rate=withY.filter(r=>+r.Survived===1).length/withY.length; if(rate<=0.25||rate>=0.75) alerts.push(`⚠️ Class imbalance: survival ${(rate*100).toFixed(1)}%`); }
const ages=rows.map(r=> r.Age!=null? +r.Age : null).filter(v=>v!=null); const s=std(ages); if(s && s>15) alerts.push(`ℹ️ Wide spread in Age (σ ≈ ${s.toFixed(1)})`);
document.getElementById('alerts').innerHTML = alerts.length? alerts.map(a=>`<li>${a}</li>`).join('') : '<li>✅ No issues detected for current filter.</li>';
}


function render(){ const rows=filtered(); kpis(rows); genderDiverging(rows); classStack(rows); ageBox(rows); scatter(rows); embarked100(rows); corrHeat(rows); buildAlerts(rows); }


// ---------- Boot ----------
(async function(){
try{
TRAIN = await parseCsv('train.csv');
// basic feature engineering
TRAIN.forEach(r=>{ r.FamilySize=(r.SibSp||0)+(r.Parch||0); });
render();
['fSex','fClass','fEmb'].forEach(id=> document.getElementById(id).addEventListener('change', render));
document.getElementById('dlBtn').addEventListener('click', ()=> downloadCsv('titanic_filtered_train.csv', filtered()));
window.addEventListener('resize', ()=>{ ['chGender','chClass','chAgeBox','chScatter','chEmb','chCorr'].forEach(id=> echarts.getInstanceByDom(document.getElementById(id))?.resize()); });
}catch(e){ alert('Failed to load CSV. Ensure train.csv is next to index.html.'); console.error(e); }
})();
</script>
</body>
</html>
